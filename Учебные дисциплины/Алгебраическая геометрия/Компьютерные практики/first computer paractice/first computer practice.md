# Задача №1
## Основная часть ($p \rightarrow p'$)
Пусть $f(a_x, a_y, a_z)$ - функция, переводящая точку $p$ куба с вершинами $\begin{pmatrix} 0 \\ 0 \\ 0 \end{pmatrix}, \begin{pmatrix} 1 \\ 0 \\ 0 \end{pmatrix}, \begin{pmatrix} 0 \\ 1 \\ 0 \end{pmatrix}, \begin{pmatrix} 0 \\ 0 \\ 1 \end{pmatrix}$ в соответственную точку $p'$ параллелепипеда с координатами $w, x, y, z$.
Тогда $f(0, 0, 0) = w, f(1, 0, 0) = x, f(0, 1, 0) = y, f(0, 0, 1) = z$. 

Назовём $p'$ образом $p$, множество вершин куба $V = \{i, j, k \mid i, j, k \in \{ 0, 1\} \}$

Рассмотрим, каким образом смещается образ точки p, если , если в исходном кубе сделать единичный шаг по направлению $e_1$:

1. Для любых $p \in V \text{ таких, что } p+e_1, \; p+e_2, \; p+e_1+e_2 \in V$ вершины $\{ p, \; p+e_1, \; p+e_2, \; p+e_1+e_2 \}$ образуют квадрат следует, что $(p + e_1) - p = (p + e_1 + e_2) - (p + e_2) = e_1$. Аналогично для направлений $e_2, \; e_3$.
2. То же равенство для образов $f(..)$: По условию задачи деформации переводят соответствующие вершины куба в вершины параллелепипеда, ребра - в рёбра. Значит, каждой грани куба соответствует параллелограмм. Для параллелограмма противоположные стороны равны, поэтому для тех же $p$ выполняется: $f(p + e_1) - f(p) = f(p + e_1 + e_2) - f(p + e_2)$.
   $f(p + e_1) - f(p) = f(p + e_1 + e_3) - f(p + e_3)$
   Обозначим $\overline{u_1}(p) := f(p + e_1) - f(p)$. Тогда $\overline{u_1}(p)=\overline{u_1}(p + e_2)$ и $\overline{u_1}(p) = \overline{u_1}(p + e_3)$. Значит, если мы сдвигаемся по направлению $e_1$, то вектор от начальной точки к конечной не изменится, если мы сдвинулись вдоль $e_2$ или $e_3$.
   Аналогично для $u_2, \; u_3$
То есть единичный шаг вдоль $e_1$ всегда прибавляет $u_1$ и только $u_1$, аналогично для $e_2, \; e_3$.
Рассмотрим произвольную точку куба $(a, b, c)$, где $0 \leq a, \; b, \; c \leq 1$. Любую такую точку можно представить как сумму трёх радиус-векторов (шагов вдоль осей): $(a, b, c) = (0,0,0) + (a, 0, 0) + (0, b, 0) + (0, 0, c)$.

Тогда образ точки $(a,b,c)$ определяется как сумма образов этих шагов:

$f(a,b,c) = f(0,0,0) + a \overline{u_1} + b \overline{u_2} + c \overline{u_3} = w + a \overline{u_1} + b \overline{u_2} + c \overline{u_3}$
При этом векторы $\overline{u_1}, \overline{u_2}, \overline{u_3}$ можно выразить через образы единичных базисных векторов:
$\overline{u_1} = f(1,0,0) - f(0,0,0) = x - w, \quad \overline{u_2} = f(0,1,0) - f(0,0,0) = y - w, \quad \overline{u_3} = f(0,0,1) - f(0,0,0) = z - w$
Следовательно, окончательная формула для любой точки $(a,b,c)$ внутри куба:
$\boxed{f(a,b,c) = w + a (x-w) + b (y-w) + c (z-w)}$
Если точка лежит вне куба, по условию задачи мы оставляем её без изменений (такую точку нужно будет вернуть в коде):
$f(a,b,c) = (a,b,c), \quad \text{если } a<0 \text{ или } a>1 \text{ или } b<0 \text{ или } b>1 \text{ или } c<0 \text{ или } c>1.$
## Проверка $p \in [ 0, \; 1 ] ^3$ 
Единичный куб с вершинами $\{(x, \; y, \; z) \mid x, \; y, \; z \in \{ 0, \; 1 \} \}$ - это множество всех точек $(a, b, c)$, координаты которых удовлетворяют $0 \leq a, \; b, \; c \leq 1$.

Чтобы найти вектор $p_1$ - от $O$ до проекции точки $p$ на $e_1$:
$$
p_1 = \boxed{\frac{\overline{p} \cdot \overline{e_1}}{\mid \overline{e_1} \mid ^2}} = \frac{\mid \overline{p} \mid * \mid \overline{e_1} \mid * \; cos{\angle(\overline{p_1}, \; \overline{e_1})}}{\mid \overline{e_1} \mid ^2} = \frac{\mid \overline{p_1} \mid * \cos{\angle{(\overline{p_1}, \; \overline{e_1})}}}{\mid \overline{e_1} \mid} = \text{пр}_{e_1}p
$$
```python
def original_to_copy(p, w, x, y, z):
    '''Транслировать точку p из эталона в копию'''
    e1 = np.array([1.,0.,0.])  # в учебных целях в этой подзадаче запрещено создавать другие...
    e2 = np.array([0.,1.,0.])  # ...векторы с явно заданными координатами, помимо e1,e2,e3
    e3 = np.array([0.,0.,1.])
    # здесь мог бы быть ваш код
    coeff1 = np.dot(p, e1) / np.dot(e1, e1)
    coeff2 = np.dot(p, e2) / np.dot(e2, e2)
    coeff3 = np.dot(p, e3) / np.dot(e3, e3)
    if (not((0 <= coeff1 <= 1) and (0 <= coeff2 <= 1) and (0 <= coeff3 <= 1))):
        return p
    u1 = x - w
    u2 = y - w
    u3 = z - w
    pImage = w + coeff1 * u1 + coeff2 * u2 + coeff3 * u3
    return pImage
```



# Задача №2
$\overline{u_1} = f(1,0,0) - f(0,0,0) = x - w, \quad \overline{u_2} = f(0,1,0) - f(0,0,0) = y - w, \quad \overline{u_3} = f(0,0,1) - f(0,0,0) = z - w$
Нужно проверить, лежит ли точка $p$ в параллелепипеде $w, x, y, z$. Введём вектор $\overline{k} = p - w$.
Смешанное произведение $(\mathbf{\overline{u_1}}, \; \mathbf{\overline{u_2}}, \; \mathbf{\overline{u_3}})$ - объём параллелепипеда $w,x,y,z$.
$(\mathbf{\overline{u_1}}, \; \mathbf{\overline{u_2}}, \; \mathbf{\overline{u_3}}) = \overline{u_1} \cdot (\overline{u_2} \times \overline{u_2})$  - это произведение $\text{пр}_{\overline{u_2} \times \overline{u_3}}u_1 \text{ на } \overline{u_2} \times \overline{u_3}$. 
Следовательно, если вместо $\overline{u_1}$ подставить $\overline{k}$, то, если смешанное произведение $\overline{k} \cdot (\overline{u_2} \times \overline{u_3}) \gt \overline{u_1} \cdot (\overline{u_2} \times \overline{u_3})$, то $p$ лежит за пределами параллелепипеда, так как это значит, что $p$ лежит от плоскости $w, w + \overline{u_2},w + \overline{u_3}$ дальше, чем плоскость $w+\overline{u_1}, w+\overline{u_1} + \overline{u_2}, w+\overline{u_1} + \overline{u_3}$ (расстояние до которой равно проекции $\overline{u_1}$ на $\overline{u_2} \times \overline{u_3}$)
Если $\overline{k} \cdot (\overline{u_2} \times \overline{u_3}) \lt 0$, то точка $p$ также лежит вне параллелепипеда. 
Аналогично для $\overline{u_2}, \overline{u_3}$.
```python
def inside_parallelepiped(p, w, x, y, z):

    '''True, если p внутри параллелепипеда на w,x,y,z, и False иначе'''

    # здесь мог бы быть ваш код
    eps = 1e-9
    u1 = x - w
    u2 = y - w
    u3 = z - w
    k = p - w
    volume = np.dot(u1, np.cross(u2, u3))
    pu2u3 = np.dot(k, np.cross(u2, u3))
    pu1u2 = np.dot(k, np.cross(u1, u2))
    pu3u1 = np.dot(k, np.cross(u3, u1))
    if ((0 - eps <= pu2u3 <= volume + eps) and (0 - eps <= pu1u2 <= volume + eps) and (0 - eps <= pu3u1 <= volume + eps)):
        return True
    return False
```

# Задача №3
Заметим, что $$
\frac{\overline{k} \cdot (\overline{u_2} \times \overline{u_3})}{\overline{u_1} \cdot (\overline{u_2} \times \overline{u_3})}=\frac{\overline{k}}{\overline{u_1}}
$$
Если из [[#Задача №2]] мы получили ответ "True", значит $p$ лежит в параллелепипеде и $0 \leq \frac{\overline{k}}{\overline{u_1}} \leq 1$.
Из доказанного в [[#Задача №1]] следует, что точке $p$ в параллелограмме соответствует точка с координатами $$
(\frac{\overline{k}}{\overline{u_1}}, \; \frac{\overline{k}}{\overline{u_2}}, \; \frac{\overline{k}}{\overline{u_3}})
$$
```python
def copy_to_original(p, w, x, y, z):
    '''Транслировать точку p из копии в эталон'''
    # здесь мог бы быть ваш код
    res = np.array([1,1,1])
    eps = 1e-9
    if(inside_parallelepiped(p, w, x, y, z)):
        u1 = x - w
        u2 = y - w
        u3 = z - w
        k = p - w
        volume = np.dot(u1, np.cross(u2, u3))
        v1 = np.dot(k, np.cross(u2, u3)) / volume
        v2 = np.dot(k, np.cross(u3, u1)) / volume
        v3 = np.dot(k, np.cross(u1, u2)) / volume
        return np.array([v1, v2, v3])
    return None
```
# Задача №4
Разделим каждый четырёхугольник на два треугольника:
![[Pasted image 20251011214706.png]]
>Пример для выпуклого и невыпуклого четырёхугольников

Заметим, что они тоже касаются друг друга по рёбрам и объём пирамиды с четырёхугольником в основании равен сумме объемов пирамид с треугольниками в основании.
![[Pasted image 20251011220348.png]]
$$
V_{ABCW} = \frac{\vec{AW} \cdot (\vec{AC} \times \vec{AB})}{6}
$$
так как $S_{\triangle{ABC}} = \begin{vmatrix}\frac{\vec{AC} \times \vec{AB}}{2}\end{vmatrix}$ и объем тетраэдра равен $\frac{S_{осн} * h}{3}$. Аналогично для второго тетраэдра: $V_{ACDW} = \frac{\vec{AW} \cdot (\vec{AD} \times \vec{AC})}{6}$. Общий объём четырёхугольника - их сумма.
Рассмотрим случай, когда четырёхугольник невыпуклый:
![[Pasted image 20251012162827.png]]
В случае слева, получаем два треугольника: $\triangle{ABC}, \; \triangle{ACD}$. Заметим, что в $\triangle{ABC}$ смешанное произведение больше нуля, а в $\triangle{ACD}$ - отрицательно (т.к. т. $D$ теперь находится по другую сторону от $AC$, то векторные произведения для треугольников  $\uparrow \downarrow$). Значит, $V_{ABCDW} = \begin{vmatrix} \frac{\vec{AW} \cdot (\vec{AC} \times \vec{AB})}{6} + \frac{\vec{AW} \cdot (\vec{AD} \times \vec{AC})}{6} \end{vmatrix}$.
В случае справа всё работает как в основном обосновании выше (два треугольника, чья площадь в сумме равна площади исходного треугольника).
Модуль необходим, так как точка $W$ находится внутри фигуры и из-за того, что $\vec{AW} = W-A$ будет иметь разные знаки в разных случаях, то и общее произведение будет давать различные по знаку объемы.
```python
def volume_with_help(polygons, w):
    '''Объём тела, ограниченного сеткой из четырёхугольников'''
    vol = 0
    for a, b, c, d in polygons:  # перебрать все четырёхугольники a,b,c,d
        temp = (np.dot(a - w, np.cross(c - w, b - w)) / 6)
        temp += (np.dot(a - w, np.cross(d - w, c - w)) / 6)
        vol += abs(temp)
    return vol
```

# Задача №5
Любой $n$-угольник можно разбить на $n-2$ треугольников следующим образом:.
Пример:
![[Pasted image 20251012170313.png]]
Тогда объем пирамиды с $n$-угольником в основании равен сумме объемов тетраэдров, с треугольниками из разбиения в основании.
Опять же, рассмотрим невыпуклый $n$-угольник:
![[Pasted image 20251012171329.png]]
$\triangle{ABC}\colon \; \vec{AB} \times \vec{AC} \uparrow \downarrow \vec{AC} \times \vec{AD}$. Значит, из $S_{\triangle{ABC}}$ вычтется $S_{\triangle{ACD}}$. Получится $S_{ABCD}$. Потом добавится $S_\triangle{ADE}$... Таким образом, любая невыпуклая часть компенсируется и в итоге получится площадь $n$-угольника. 
Значит вместо двух треугольников, как в [[#Задача №4]], нужно сложить площади $n-2$ треугольников, у которых одна вершина общая, а остальные идут последовательно: $\triangle{ABC}, \triangle{ACD}, \triangle{ADE}...$
Полученную сумму нужно домножить на высоту пирамиды H (скалярное произведение на векторное произведение) и взять по модулю.

## Выбор вершины $w$ для подсчёт объемов.
Заметим, что если вершина лежит за пределами фигуры, то, если бы для каждого $n$-угольника сумма векторных произведений треугольников смотрела внутрь фигуры или за ее пределы (главное, что для всех одинаково), то, если не брать модули, разница в знаках позволит нам компенсировать те объемы, которые мы посчитаем, но которые не будут входить в фигуру. 
>Но так как по условию нам не сказано, что вершины даны, например, в порядке обхода по периметру по часовой стрелке, если смотреть, например, от той же точки $w$, лежащей за пределами фигуры, то мы не можем вычислять таким образом. Дано, что вершины даются в порядке обхода по периметру и всё.
  Значит, необходимо выбрать другую точку $w$.

Если взять точку $w$, лежащую внутри фигуры, то всё будет работать (используем модули по соображениям из [[#Задача №4]]).  Для этого можно взять любую вершину, которая содержится в множестве вершин фигуры (например, самую первую самого первого $n$-угольника) и использовать её как точку $w$. Она содержится в фигуре по определению.

```python
def polyhedron_volume(faces):
    '''Объём выпуклого тела по списку граней (любая длина грани)'''
    w = faces[0][0]
    vol = 0.0
    for f in faces:
        n = len(f)
        temp = 0
        a = f[0]
        for i in range(1, n - 1):
            b, c = f[i], f[i + 1]
            temp += np.dot(a - w, np.cross(b - w, c - w)) / 6.0
        vol += abs(temp)
    return abs(vol)
```
